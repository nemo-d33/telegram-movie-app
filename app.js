const tg = window.Telegram.WebApp;

let movies = [];
let filteredMovies = [];
let currentCategory = 'all';

function initApp() {
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();
    
    showLoading();
    
    setTimeout(() => {
        loadMovies();
        hideLoading();
        renderMovies(movies);
        setupEventListeners();
        setupSmoothAnimations();
    }, 1000);
}

function setupSmoothAnimations() {
    // Add smooth entrance animations for elements
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    // Observe movie cards for animation
    setTimeout(() => {
        document.querySelectorAll('.movie-card').forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(card);
        });
    }, 100);
}

function loadMovies() {
    movies = [
        {
            id: 1,
            title: "–§–æ—Ä—Å–∞–∂ 9",
            year: "2021",
            poster: "https://images.unsplash.com/photo-1594909122845-11baa439b7bf?w=400&h=500&fit=crop",
            rutubeEmbedUrl: "https://rutube.ru/play/embed/bb0c848e121e79263789b3b19460bff0/",
            rutubePageUrl: "https://rutube.ru/video/bb0c848e121e79263789b3b19460bff0/",
            category: "films",
            description: "–î–æ–º–∏–Ω–∏–∫ –¢–æ—Ä–µ—Ç—Ç–æ –≤–µ–¥–µ—Ç —Å–ø–æ–∫–æ–π–Ω—É—é –∂–∏–∑–Ω—å —Å –õ–µ—Ç—Ç–∏ –∏ —Å–≤–æ–∏–º —Å—ã–Ω–æ–º, –Ω–æ –ø–æ–∫–æ–π –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ–¥–æ–ª–≥–∏–º."
        },
        {
            id: 2,
            title: "–ú—Å—Ç–∏—Ç–µ–ª–∏: –§–∏–Ω–∞–ª",
            year: "2019",
            poster: "https://images.unsplash.com/photo-1635805737707-575885ab0820?w=400&h=500&fit=crop",
            rutubeEmbedUrl: "https://rutube.ru/play/embed/1234567891",
            rutubePageUrl: "https://rutube.ru/video/1234567891/",
            category: "films",
            description: "–û—Å—Ç–∞–≤—à–∏–µ—Å—è –≤ –∂–∏–≤—ã—Ö —á–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –ú—Å—Ç–∏—Ç–µ–ª–µ–π –ø—ã—Ç–∞—é—Ç—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–µ–π—Å—Ç–≤–∏–π –¢–∞–Ω–æ—Å–∞."
        },
        {
            id: 3,
            title: "–ò–≥—Ä–∞ –≤ –∫–∞–ª—å–º–∞—Ä–∞",
            year: "2021",
            poster: "https://images.unsplash.com/photo-1560169897-fc0cdbdfa4d5?w=400&h=500&fit=crop",
            rutubeEmbedUrl: "https://rutube.ru/play/embed/1234567892",
            rutubePageUrl: "https://rutube.ru/video/1234567892/",
            category: "series",
            description: "–°–æ—Ç–Ω–∏ –∏–≥—Ä–æ–∫–æ–≤-–±–∞–Ω–∫—Ä–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å—ã–≥—Ä–∞—Ç—å –≤ –¥–µ—Ç—Å–∫–∏–µ –∏–≥—Ä—ã –Ω–∞ –≤—ã–∂–∏–≤–∞–Ω–∏–µ."
        },
        {
            id: 4,
            title: "–•–æ–ª–æ–¥–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ",
            year: "2013",
            poster: "https://images.unsplash.com/photo-1618336756473-37d8fcf7d7be?w=400&h=500&fit=crop",
            rutubeEmbedUrl: "https://rutube.ru/play/embed/1234567893",
            rutubePageUrl: "https://rutube.ru/video/1234567893/",
            category: "cartoons",
            description: "–ë–µ—Å—Å—Ç—Ä–∞—à–Ω–∞—è –ê–Ω–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –≥–æ—Ä—ã, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–≤–æ—é —Å–µ—Å—Ç—Ä—É –≠–ª—å–∑—É."
        },
        {
            id: 5,
            title: "–î–∂–æ–Ω –£–∏–∫ 4",
            year: "2023",
            poster: "https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=500&fit=crop",
            rutubeEmbedUrl: "https://rutube.ru/play/embed/1234567894",
            rutubePageUrl: "https://rutube.ru/video/1234567894/",
            category: "films",
            description: "–î–∂–æ–Ω –£–∏–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –±–æ—Ä–æ—Ç—å—Å—è —Å –º–∞—Ñ–∏–µ–π –∏ –Ω–∞–µ–º–Ω–∏–∫–∞–º–∏ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É."
        },
        {
            id: 6,
            title: "–í–µ–¥—å–º–∞–∫",
            year: "2019",
            poster: "https://images.unsplash.com/photo-1534447677768-be436bb09401?w=400&h=500&fit=crop",
            rutubeEmbedUrl: "https://rutube.ru/play/embed/1234567895",
            rutubePageUrl: "https://rutube.ru/video/1234567895/",
            category: "series",
            description: "–ì–µ—Ä–∞–ª—å—Ç –∏–∑ –†–∏–≤–∏–∏, –º—É—Ç–∞–Ω—Ç-–æ—Ö–æ—Ç–Ω–∏–∫ –Ω–∞ —á—É–¥–æ–≤–∏—â, –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ —Å–≤–æ–µ –º–µ—Å—Ç–æ –≤ –º–∏—Ä–µ."
        }
    ];
    
    filteredMovies = [...movies];
}

function renderMovies(moviesArray) {
    const moviesList = document.getElementById('moviesList');
    
    if (moviesArray.length === 0) {
        moviesList.innerHTML = `
            <div class="glass-empty-state">
                <div style="font-size: 3em; margin-bottom: 20px;">üé¨</div>
                <div style="font-size: 1.2em; color: rgba(255, 255, 255, 0.8);">
                    –§–∏–ª—å–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </div>
                <div style="color: rgba(255, 255, 255, 0.6); margin-top: 10px;">
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                </div>
            </div>
        `;
        return;
    }
    
    moviesList.innerHTML = moviesArray.map(movie => `
        <div class="movie-card" onclick="openMovie(${movie.id})">
            <img src="${movie.poster}" alt="${movie.title}" class="movie-poster"
                 onerror="this.src='https://images.unsplash.com/photo-1485846234645-a62644f84728?w=400&h=500&fit=crop'">
            <div class="movie-info">
                <div class="movie-title">${movie.title}</div>
                <div class="movie-year">${movie.year}</div>
            </div>
        </div>
    `).join('');
}

function openMovie(movieId) {
    const movie = movies.find(m => m.id === movieId);
    if (!movie) return;
    
    // Create smooth modal appearance
    tg.showPopup({
        title: `üé¨ ${movie.title}`,
        message: `${movie.year}\n\n${movie.description}`,
        buttons: [
            {id: 'watch', type: 'default', text: 'üé• –°–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º'},
            {id: 'cancel', type: 'cancel'}
        ]
    }, function(buttonId) {
        if (buttonId === 'watch') {
            playRuTubeVideo(movie.rutubeEmbedUrl, movie.rutubePageUrl, movie.title);
        }
    });
}

function playRuTubeVideo(embedUrl, pageUrl, title) {
    const playerContainer = document.getElementById('playerContainer');
    const videoPlayerContainer = document.getElementById('rutubePlayer');
    
    console.log('Opening RuTube video:', embedUrl);
    
    // Enhanced iframe with better fullscreen support
    videoPlayerContainer.innerHTML = `
        <iframe 
            class="rutube-iframe"
            src="${embedUrl}" 
            frameborder="0" 
            allow="autoplay; encrypted-media; fullscreen; picture-in-picture"
            allowfullscreen
            webkitallowfullscreen
            mozallowfullscreen
            msallowfullscreen
        ></iframe>
    `;
    
    // Smooth player entrance
    playerContainer.style.display = 'flex';
    playerContainer.style.opacity = '0';
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        playerContainer.style.opacity = '1';
        playerContainer.style.transition = 'opacity 0.3s ease';
    }, 10);
    
    // Enhanced fallback with better user experience
    setTimeout(() => {
        const iframe = videoPlayerContainer.querySelector('iframe');
        if (!iframe || !iframe.contentWindow) {
            tg.showAlert('–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä... –û—Ç–∫—Ä—ã–≤–∞—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞');
            setTimeout(() => {
                window.open(pageUrl, '_blank');
                closePlayer();
            }, 1500);
        }
    }, 5000);
}

function closePlayer() {
    const playerContainer = document.getElementById('playerContainer');
    const videoPlayerContainer = document.getElementById('rutubePlayer');
    
    // Smooth exit animation
    playerContainer.style.opacity = '0';
    
    setTimeout(() => {
        // Stop and cleanup
        videoPlayerContainer.innerHTML = '';
        playerContainer.style.display = 'none';
        playerContainer.classList.remove('fullscreen');
        document.body.style.overflow = 'auto';
    }, 300);
}

function toggleFullscreen() {
    const playerContainer = document.getElementById('playerContainer');
    playerContainer.classList.toggle('fullscreen');
}

function setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    
    // Enhanced search with debouncing
    let searchTimeout;
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchTerm = e.target.value.toLowerCase().trim();
            filterMovies(searchTerm, currentCategory);
        }, 300);
    });
    
    // Enhanced category buttons with ripple effect
    const categoryBtns = document.querySelectorAll('.glass-category-btn');
    categoryBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            categoryBtns.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            
            const category = this.dataset.category;
            currentCategory = category;
            filterMovies(searchInput.value.toLowerCase().trim(), category);
        });
    });
    
    // Enhanced keyboard controls
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePlayer();
        }
        if (e.key === 'F11' || (e.altKey && e.key === 'Enter')) {
            e.preventDefault();
            toggleFullscreen();
        }
    });
    
    // Close player when clicking on backdrop
    document.getElementById('playerContainer').addEventListener('click', function(e) {
        if (e.target === this) {
            closePlayer();
        }
    });
}

function filterMovies(searchTerm, category) {
    let results = [...movies];
    
    // Filter by category
    if (category !== 'all') {
        results = results.filter(movie => movie.category === category);
    }
    
    // Filter by search term
    if (searchTerm) {
        results = results.filter(movie => 
            movie.title.toLowerCase().includes(searchTerm) ||
            movie.description.toLowerCase().includes(searchTerm)
        );
    }
    
    filteredMovies = results;
    renderMovies(filteredMovies);
}

function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('moviesList').innerHTML = '';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

// Initialize app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
